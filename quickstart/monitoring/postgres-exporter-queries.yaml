# Custom PostgreSQL queries for FHIR server monitoring
# These extend the default postgres_exporter metrics with FHIR-specific insights

pg_stat_statements:
  query: |
    SELECT
      queryid,
      substring(query, 1, 100) AS query_short,
      calls,
      total_exec_time,
      mean_exec_time,
      stddev_exec_time,
      min_exec_time,
      max_exec_time,
      rows
    FROM pg_stat_statements
    WHERE query NOT LIKE '%pg_stat_statements%'
    ORDER BY mean_exec_time DESC
    LIMIT 50
  metrics:
    - queryid:
        usage: "LABEL"
        description: "Query ID"
    - query_short:
        usage: "LABEL"
        description: "Query text (truncated)"
    - calls:
        usage: "COUNTER"
        description: "Number of times executed"
    - total_exec_time:
        usage: "COUNTER"
        description: "Total time spent executing this query (ms)"
    - mean_exec_time:
        usage: "GAUGE"
        description: "Mean execution time (ms)"
    - stddev_exec_time:
        usage: "GAUGE"
        description: "Standard deviation of execution time (ms)"
    - min_exec_time:
        usage: "GAUGE"
        description: "Minimum execution time (ms)"
    - max_exec_time:
        usage: "GAUGE"
        description: "Maximum execution time (ms)"
    - rows:
        usage: "COUNTER"
        description: "Total number of rows returned"

pg_table_stats:
  query: |
    SELECT
      schemaname,
      tablename,
      pg_total_relation_size(schemaname||'.'||tablename) AS total_bytes,
      pg_relation_size(schemaname||'.'||tablename) AS table_bytes,
      pg_indexes_size(schemaname||'.'||tablename) AS index_bytes,
      n_tup_ins,
      n_tup_upd,
      n_tup_del,
      n_live_tup,
      n_dead_tup,
      last_vacuum,
      last_autovacuum,
      last_analyze,
      last_autoanalyze
    FROM pg_stat_user_tables
    WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
  metrics:
    - schemaname:
        usage: "LABEL"
        description: "Schema name"
    - tablename:
        usage: "LABEL"
        description: "Table name"
    - total_bytes:
        usage: "GAUGE"
        description: "Total table size including indexes (bytes)"
    - table_bytes:
        usage: "GAUGE"
        description: "Table size excluding indexes (bytes)"
    - index_bytes:
        usage: "GAUGE"
        description: "Index size (bytes)"
    - n_tup_ins:
        usage: "COUNTER"
        description: "Number of rows inserted"
    - n_tup_upd:
        usage: "COUNTER"
        description: "Number of rows updated"
    - n_tup_del:
        usage: "COUNTER"
        description: "Number of rows deleted"
    - n_live_tup:
        usage: "GAUGE"
        description: "Estimated number of live rows"
    - n_dead_tup:
        usage: "GAUGE"
        description: "Estimated number of dead rows"

pg_fhir_search_stats:
  query: |
    SELECT
      'search_string' AS table_type,
      COUNT(*) AS row_count,
      pg_total_relation_size('search_string') AS total_bytes
    FROM search_string
    UNION ALL
    SELECT
      'search_token' AS table_type,
      COUNT(*) AS row_count,
      pg_total_relation_size('search_token') AS total_bytes
    FROM search_token
    UNION ALL
    SELECT
      'search_number' AS table_type,
      COUNT(*) AS row_count,
      pg_total_relation_size('search_number') AS total_bytes
    FROM search_number
    UNION ALL
    SELECT
      'search_date' AS table_type,
      COUNT(*) AS row_count,
      pg_total_relation_size('search_date') AS total_bytes
    FROM search_date
    UNION ALL
    SELECT
      'search_reference' AS table_type,
      COUNT(*) AS row_count,
      pg_total_relation_size('search_reference') AS total_bytes
    FROM search_reference
    UNION ALL
    SELECT
      'search_uri' AS table_type,
      COUNT(*) AS row_count,
      pg_total_relation_size('search_uri') AS total_bytes
    FROM search_uri
  metrics:
    - table_type:
        usage: "LABEL"
        description: "Search parameter table type"
    - row_count:
        usage: "GAUGE"
        description: "Number of indexed search parameter values"
    - total_bytes:
        usage: "GAUGE"
        description: "Total table size (bytes)"

pg_fhir_resources:
  query: |
    SELECT
      resource_type,
      COUNT(*) AS resource_count,
      COUNT(DISTINCT id) AS unique_resources,
      MAX(version_id) AS max_version,
      AVG(version_id::numeric) AS avg_version
    FROM resources
    GROUP BY resource_type
    ORDER BY resource_count DESC
  metrics:
    - resource_type:
        usage: "LABEL"
        description: "FHIR resource type"
    - resource_count:
        usage: "GAUGE"
        description: "Total number of resource versions"
    - unique_resources:
        usage: "GAUGE"
        description: "Number of unique resources (distinct IDs)"
    - max_version:
        usage: "GAUGE"
        description: "Highest version number"
    - avg_version:
        usage: "GAUGE"
        description: "Average version number"

pg_locks_detail:
  query: |
    SELECT
      mode,
      locktype,
      COUNT(*) AS count
    FROM pg_locks
    GROUP BY mode, locktype
  metrics:
    - mode:
        usage: "LABEL"
        description: "Lock mode"
    - locktype:
        usage: "LABEL"
        description: "Lock type"
    - count:
        usage: "GAUGE"
        description: "Number of locks"
